<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>阿里云Elasticsearch性能优化实践</title>
    <style type="text/css" media="all">
      body {
        margin: 0;
        font-family: "Helvetica Neue", Helvetica, Arial, "Hiragino Sans GB", sans-serif;
        font-size: 14px;
        line-height: 20px;
        color: #777;
        background-color: white;
      }
      .container {
        width: 700px;
        margin-right: auto;
        margin-left: auto;
      }

      .post {
        font-family: Georgia, "Times New Roman", Times, "SimSun", serif;
        position: relative;
        padding: 70px;
        bottom: 0;
        overflow-y: auto;
        font-size: 16px;
        font-weight: normal;
        line-height: 25px;
        color: #515151;
      }

      .post h1{
        font-size: 50px;
        font-weight: 500;
        line-height: 60px;
        margin-bottom: 40px;
        color: inherit;
      }

      .post p {
        margin: 0 0 35px 0;
      }

      .post img {
        border: 1px solid #D9D9D9;
      }

      .post a {
        color: #28A1C5;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="post">
        <h1 class="title">阿里云Elasticsearch性能优化实践</h1>
        <div class="show-content">
          <p><a href="https://note.youdao.com/ynoteshare1/index.html?id=9b9447e2c77f63a9f9b479ffc64869cd&amp;type=note" target="_blank">https://note.youdao.com/ynoteshare1/index.html?id=9b9447e2c77f63a9f9b479ffc64869cd&amp;type=note</a></p><p>摘要：      Elasticsearch是一款流行的分布式开源搜索和数据分析引擎，具备高性能、易扩展、容错性强等特点。它强化了Apache Lucene的搜索能力，把掌控海量数据索引和查询的方式提升到一个新的层次。</p><p>     Elasticsearch是一款流行的分布式开源搜索和数据分析引擎，具备高性能、易扩展、容错性强等特点。它强化了Apache Lucene的搜索能力，把掌控海量数据索引和查询的方式提升到一个新的层次。本文结合开源社区和阿里云平台的实践经验，探讨如何调优Elasticsearch的性能提高索引和查询吞吐量。</p><p>一. Elasticsearch部署建议</p><p>1.选择合理的硬件配置，尽可能使用SSD</p><p>      Elasticsearch最大的瓶颈往往是磁盘读写性能，尤其是随机读取性能。使用SSD（PCI-E接口SSD卡/SATA接口SSD盘）通常比机械硬盘（SATA盘/SAS盘）查询速度快5~10倍，写入性能提升不明显。</p><p>        对于文档检索类查询性能要求较高的场景，建议考虑SSD作为存储，同时按照1:10的比例配置内存和硬盘。对于日志分析类查询并发要求较低的场景，可以考虑采用机械硬盘作为存储，同时按照1:50的比例配置内存和硬盘。单节点存储数据建议在2TB以内，最大不要超过5TB，避免查询速度慢、系统不稳定。</p><p>        在单机存储1TB数据场景下，SATA盘和SSD盘的全文检索性能对比（测试环境：Elasticsearch5.5.3，10亿条人口户籍登记信息，单机16核CPU、64GB内存，12块6TB SATA盘，2块1.5 TB SSD盘）：</p><p>磁盘类型并发数QPS平均检索响应时间50%请求响应时间90%请求响应时间IOPS</p><p>SATA盘10并发17563ms478ms994ms1200</p><p>SATA盘50并发64773ms711ms1155ms1800</p><p>SATA盘100并发110902ms841ms1225ms2040</p><p>SATA盘200并发842369ms2335ms2909ms2400</p><p>SSD盘10并发94105ms90ms200ms25400</p><p>SSD盘50并发144346ms341ms411ms66000</p><p>SSD盘100并发152654ms689ms791ms60000</p><p>SSD盘200并发210950ms1179ms1369ms60000</p><p>        2.给JVM配置机器一半的内存，但是不建议超过32G</p><p>        修改conf/jvm.options配置，-Xms和-Xmx设置为相同的值，推荐设置为机器内存的一半左右，剩余一半留给操作系统缓存使用。jvm内存建议不要低于2G，否则有可能因为内存不足导致ES无法正常启动或内存溢出，jvm建议不要超过32G，否则jvm会禁用内存对象指针压缩技术，造成内存浪费。机器内存大于64G内存时，推荐配置-Xms30g -Xmx30g 。</p><p>        3.规模较大的集群配置专有主节点，避免脑裂问题</p><p>        Elasticsearch主节点（master节点）负责集群元信息管理、index的增删操作、节点的加入剔除，定期将最新的集群状态广播至各个节点。在集群规模较大时，建议配置专有主节点只负责集群管理，不存储数据，不承担数据读写压力。</p><p># 专有主节点配置(conf/elasticsearch.yml)：</p><p>node.master:truenode.data: falsenode.ingest:false# 数据节点配置(conf/elasticsearch.yml)：</p><p>node.master:falsenode.data:truenode.ingest:true</p><p>        Elasticsearch默认每个节点既是候选主节点，又是数据节点。最小主节点数量参数minimum_master_nodes推荐配置为候选主节点数量一半以上，该配置告诉Elasticsearch当没有足够的master候选节点的时候，不进行master节点选举，等master节点足够了才进行选举。</p><p>        例如对于3节点集群，最小主节点数量从默认值1改为2。</p><p># 最小主节点数量配置(conf/elasticsearch.yml)：</p><p>discovery.zen.minimum_master_nodes: 2</p><p>        4.Linux操作系统调优</p><p>        关闭交换分区，防止内存置换降低性能。 将/etc/fstab 文件中包含swap的行注释掉</p><p>sed -i '/swap/s/^/#/' /etc/fstab</p><p>swapoff -a</p><p>        单用户可以打开的最大文件数量，可以设置为官方推荐的65536或更大些</p><p>echo "* - nofile 655360" &gt;&gt; /etc/security/limits.conf</p><p>        单用户线程数调大</p><p>echo "* - nproc 131072" &gt;&gt; /etc/security/limits.conf</p><p>        单进程可以使用的最大map内存区域数量</p><p>echo "vm.max_map_count = 655360" &gt;&gt; /etc/sysctl.conf</p><p>        参数修改立即生效</p><p>sysctl -p</p><p>二. 索引性能调优建议</p><p>        1.设置合理的索引分片数和副本数</p><p>        索引分片数建议设置为集群节点的整数倍，初始数据导入时副本数设置为0，生产环境副本数建议设置为1（设置1个副本，集群任意1个节点宕机数据不会丢失；设置更多副本会占用更多存储空间，操作系统缓存命中率会下降，检索性能不一定提升）。单节点索引分片数建议不要超过3个，每个索引分片推荐10-40GB大小。索引分片数设置后不可以修改，副本数设置后可以修改。Elasticsearch6.X及之前的版本默认索引分片数为5、副本数为1，从Elasticsearch7.0开始调整为默认索引分片数为1、副本数为1。</p><p>        不同分片数对写入性能的影响（测试环境：7节点Elasticsearch6.3集群，写入30G新闻数据，单节点56核CPU、380G内存、3TB SSD卡，0副本，20线程写入，每批次提交10M左右数据。）：</p><p>集群索引分片数单节点索引分片数写入耗时</p><p>20/1600s</p><p>71327s</p><p>142258s</p><p>213211s</p><p>284211s</p><p>568214s</p><p>        索引设置：</p><p>curl -XPUT http://localhost:9200/fulltext001?pretty -H 'Content-Type: application/json'   -d '{</p><p>    "settings" : {</p><p>      "refresh_interval": "30s",</p><p>      "merge.policy.max_merged_segment": "1000mb",</p><p>      "translog.durability": "async",</p><p>      "translog.flush_threshold_size": "2gb",</p><p>      "translog.sync_interval": "100s",</p><p>      "index" : {</p><p>        "number_of_shards" : "21",</p><p>        "number_of_replicas" : "0"      }</p><p>    }</p><p>}'</p><p>        mapping设置：</p><p>curl -XPOST http://localhost:9200/fulltext001/doc/_mapping?pretty  -H 'Content-Type: application/json' -d '{</p><p>    "doc" : {</p><p>        "_all" : {</p><p>            "enabled" : false         },</p><p>        "properties" : {</p><p>          "content" : {</p><p>            "type" : "text",</p><p>            "analyzer":"ik_max_word"          },</p><p>          "id" : {</p><p>            "type" : "keyword"          }</p><p>        }</p><p>    }</p><p>}'</p><p>        写入数据示例：</p><p>curl -XPUT 'http://localhost:9200/fulltext001/doc/1?pretty' -H 'Content-Type: application/json' -d '</p><p>{</p><p>    "id": "https://www.huxiu.com/article/215169.html",</p><p>    "content": "“娃娃机，迷你KTV，VR体验馆，堪称商场三大标配‘神器’。”一家地处商业中心的大型综合体负责人告诉懂懂笔记，在过去的这几个月里，几乎所有的综合体都“标配”了这三种“设备”…"</p><p>}'</p><p>        修改副本数示例：</p><p>curl -XPUT "http://localhost:9200/fulltext001/_settings" -H 'Content-Type: application/json' -d'</p><p>{</p><p>    "number_of_replicas": 1</p><p>}'</p><p>        2.使用批量请求</p><p>        使用批量请求将产生比单文档索引请求好得多的性能。写入数据时调用批量提交接口，推荐每批量提交5~15MB数据。例如单条记录1KB大小，每批次提交10000条左右记录写入性能较优；单条记录5KB大小，每批次提交2000条左右记录写入性能较优。</p><p>        批量请求接口API：</p><p>curl -XPOST "http://localhost:9200/_bulk" -H 'Content-Type: application/json' -d'</p><p>{ "index" : { "_index" : "test", "_type" : "_doc", "_id" : "1" } }</p><p>{ "field1" : "value1" }</p><p>{ "delete" : { "_index" : "test", "_type" : "_doc", "_id" : "2" } }</p><p>{ "create" : { "_index" : "test", "_type" : "_doc", "_id" : "3" } }</p><p>{ "field1" : "value3" }</p><p>{ "update" : {"_id" : "1", "_type" : "_doc", "_index" : "test"} }</p><p>{ "doc" : {"field2" : "value2"} }</p><p>'</p><p>         3.通过多进程/线程发送数据</p><p>        单线程批量写入数据往往不能充分利用服务器CPU资源，可以尝试调整写入线程数或者在多个客户端上同时向Elasticsearch服务器提交写入请求。与批量调整大小请求类似，只有测试才能确定最佳的worker数量。 可以通过逐渐增加工作任务数量来测试，直到集群上的I / O或CPU饱和。</p><p>        4.调大refresh interval</p><p>        在 Elasticsearch 中，写入和打开一个新段的轻量的过程叫做 refresh 。 默认情况下每个分片会每秒自动刷新一次。这就是为什么我们说 Elasticsearch 是 近 实时搜索: 文档的变化并不是立即对搜索可见，但会在一秒之内变为可见。</p><p>        并不是所有的情况都需要每秒刷新。可能你正在使用 Elasticsearch 索引大量的日志文件，你可能想优化索引速度而不是近实时搜索，可以通过设置 refresh_interval，降低每个索引的刷新频率。</p><p>        设置refresh interval API:</p><p>curl -XPUT "http://localhost:9200/index" -H 'Content-Type: application/json' -d'</p><p>{</p><p>    "settings" : {</p><p>      "refresh_interval": "30s"</p><p>    }</p><p>}'</p><p>        refresh_interval 可以在既存索引上进行动态更新。 在生产环境中，当你正在建立一个大的新索引时，可以先关闭自动刷新，待开始使用该索引时，再把它们调回来：</p><p>curl -XPUT "http://localhost:9200/index/_settings" -H 'Content-Type: application/json' -d'</p><p>{ "refresh_interval": -1 }'</p><p>curl -XPUT "http://localhost:9200/index/_settings" -H 'Content-Type: application/json' -d'</p><p>{ "refresh_interval": "1s" }'</p><p>        5.设计mapping配置合适的字段类型</p><p>        Elasticsearch在写入文档时，如果请求中指定的索引名不存在，会自动创建新索引，并根据文档内容猜测可能的字段类型。但这往往不是最高效的，我们可以根据应用场景来设计合理的字段类型。</p><p>        例如写入一条记录：</p><p>curl -XPUT "http://localhost:9200/twitter/doc/1?pretty" -H 'Content-Type: application/json' -d'</p><p>{</p><p>    "user": "kimchy",</p><p>    "post_date": "2009-11-15T13:12:00",</p><p>    "message": "Trying out Elasticsearch, so far so good?"</p><p>}'</p><p>        查询Elasticsearch自动创建的索引mapping，会发现将post_date字段自动识别为date类型，但是message和user字段被设置为text、keyword冗余字段，造成写入速度降低、占用更多磁盘空间。</p><p>curl -XGET "http://localhost:9200/twitter"</p><p>{</p><p>  "twitter": {</p><p>    "mappings": {</p><p>      "doc": {</p><p>        "properties": {</p><p>          "message": {</p><p>            "type": "text",</p><p>            "fields": {</p><p>              "keyword": {</p><p>                "type": "keyword",</p><p>                "ignore_above": 256              }</p><p>            }</p><p>          },</p><p>          "post_date": {</p><p>            "type": "date"          },</p><p>          "user": {</p><p>            "type": "text",</p><p>            "fields": {</p><p>              "keyword": {</p><p>                "type": "keyword",</p><p>                "ignore_above": 256              }</p><p>            }</p><p>          }</p><p>        }</p><p>      }</p><p>    },</p><p>    "settings": {</p><p>      "index": {</p><p>        "number_of_shards": "5",</p><p>        "number_of_replicas": "1",</p><p>      }</p><p>    }</p><p>  }</p><p>}</p><p>        根据业务场景设计索引配置合理的分片数、副本数，设置字段类型、分词器。如果不需要合并全部字段，禁用_all字段，通过copy_to来合并字段。</p><p>curl -XPUT "http://localhost:9200/twitter?pretty" -H 'Content-Type: application/json' -d'</p><p>{</p><p>    "settings" : {</p><p>      "index" : {</p><p>        "number_of_shards" : "20",</p><p>        "number_of_replicas" : "0"</p><p>      }</p><p>    }</p><p>}'</p><p>curl -XPOST "http://localhost:9200/twitter/doc/_mapping?pretty" -H 'Content-Type: application/json' -d'</p><p>{</p><p>    "doc" : {</p><p>        "_all" : {</p><p>        "enabled" : false</p><p>    },</p><p>    "properties" : {</p><p>          "user" : {</p><p>          "type" : "keyword"</p><p>          },</p><p>          "post_date" : {</p><p>            "type" : "date"</p><p>          },</p><p>          "message" : {</p><p>            "type" : "text",</p><p>            "analyzer" : "cjk"</p><p>          }</p><p>        }</p><p>    }</p><p>}'</p><p>三. 查询性能调优建议</p><p>        1.使用过滤器缓存和分片查询缓存</p><p>        默认情况下，Elasticsearch的查询会计算返回的每条数据与查询语句的相关度，但对于非全文索引的使用场景，用户并不关心查询结果与查询条件的相关度，只是想精确的查找目标数据。此时，可以通过filter来让Elasticsearch不计算评分，并且尽可能的缓存filter的结果集，供后续包含相同filter的查询使用，提高查询效率。</p><p>        普通查询：</p><p>curl -XGET "http://localhost:9200/twitter/_search" -H 'Content-Type: application/json' -d'</p><p>{</p><p>  "query": {</p><p>    "match": {</p><p>      "user": "kimchy"</p><p>    }</p><p>  }</p><p>}'</p><p>   过滤器(filter)查询：</p><p>curl -XGET "http://localhost:9200/twitter/_search" -H 'Content-Type: application/json' -d'</p><p>{</p><p>  "query": {</p><p>    "bool": {</p><p>      "filter": {</p><p>         "match": {</p><p>          "user": "kimchy"</p><p>        }</p><p>      }</p><p>    }</p><p>  }</p><p>}'</p><p>        分片查询缓存的目的是缓存聚合、提示词结果和命中数（它不会缓存返回的文档，因此，它只在search_type=count时起作用）。</p><p>        通过下面的参数我们可以设置分片缓存的大小，默认情况下是JVM堆的1%大小，当然我们也可以手动设置在config/elasticsearch.yml文件里:</p><p>indices.requests.cache.size: 1%</p><p>        查看缓存占用内存情况(name表示节点名, query_cache表示过滤器缓存，request_cache表示分片缓存，fielddata表示字段数据缓存，segments表示索引段)：</p><p>curl -XGET "http://localhost:9200/_cat/nodes?h=name,query_cache.memory_size,request_cache.memory_size,fielddata.memory_size,segments.memory&amp;v"</p><p>        2.使用路由routing</p><p>        Elasticsearch写入文档时，文档会通过一个公式路由到一个索引中的一个分片上。默认的公式如下：</p><p>shard_num = hash(_routing) % num_primary_shards</p><p>        _routing字段的取值，默认是_id字段，可以根据业务场景设置经常查询的字段作为路由字段。例如可以考虑将用户id、地区作为路由字段，查询时可以过滤不必要的分片，加快查询速度。</p><p>        写入时指定路由：</p><p>curl -XPUT "http://localhost:9200/my_index/my_type/1?routing=user1" -H 'Content-Type: application/json' -d'</p><p>{</p><p>  "title": "This is a document",</p><p>  "author": "user1"</p><p>}'</p><p>        查询时不指定路由，需要查询所有分片：</p><p>curl -XGET "http://localhost:9200/my_index/_search" -H 'Content-Type: application/json' -d'</p><p>{</p><p>  "query": {</p><p>    "match": {</p><p>      "title": "document"</p><p>    }</p><p>  }</p><p>}'</p><p>        返回结果：</p><p>{</p><p>  "took": 2,</p><p>  "timed_out": false,</p><p>  "_shards": {</p><p>    "total": 5,</p><p>    "successful": 5,</p><p>    "skipped": 0,</p><p>    "failed": 0  }</p><p>  ......</p><p>}</p><p>        查询时指定路由，只需要查询1个分片：</p><p>curl -XGET "http://localhost:9200/my_index/_search?routing=user1" -H 'Content-Type: application/json' -d'</p><p>{</p><p>  "query": {</p><p>    "match": {</p><p>      "title": "document"</p><p>    }</p><p>  }</p><p>}'</p><p>        返回结果：</p><p>{</p><p>  "took": 1,</p><p>  "timed_out": false,</p><p>  "_shards": {</p><p>    "total": 1,</p><p>    "successful": 1,</p><p>    "skipped": 0,</p><p>    "failed": 0  }</p><p>  ......</p><p>}</p><p>        3.强制合并只读索引，关闭历史数据索引</p><p>        只读的索引可以从合并成一个单独的大segment中收益，减少索引碎片，减少JVM堆常驻内存。历史数据索引如果业务上不再支持查询请求，可以考虑关闭索引，减少JVM内存占用。</p><p>        索引forcemerge API:</p><p>curl -XPOST "http://localhost:9200/abc20180923/_forcemerge"</p><p>        索引关闭API:</p><p>curl -XPOST "http://localhost:9200/abc2017*/_close"</p><p>        4.配置查询聚合节点</p><p>        查询聚合节点可以发送粒子查询请求到其他节点，收集和合并结果，以及响应发出查询的客户端。通过给查询聚合节点配置更高规格的CPU和内存，可以加快查询运算速度、提升缓存命中率。某客户使用25台8核CPU32G内存节点ELasticsearch集群，查询QPS在4000左右。增加6台16核CPU32G内存节点作为查询聚合节点，观察服务器CPU、JVM堆内存使用情况，并调整缓存、分片、副本参数，查询QPS达到12000。</p><p># 查询聚合节点配置(conf/elasticsearch.yml)：</p><p>node.master: falsenode.data: falsenode.ingest:false</p><p>        5.设置查询读取记录条数和字段</p><p>        默认的查询请求通常返回排序后的前10条记录，最多一次读取10000条记录，通过from和size参数控制读取记录范围，避免一次读取过多的记录。通过_source参数可以控制返回字段信息，尽量避免读取大字段。</p><p>        查询请求示例：</p><p>curl -XGET http://localhost:9200/fulltext001/_search?pretty  -H 'Content-Type: application/json' -d ' {</p><p>  "from": 0,</p><p>  "size": 10,</p><p>  "_source": "id",</p><p>  "query": {</p><p>    "bool": {</p><p>      "must": [</p><p>        {"match": {"content":"虎嗅"}}</p><p>      ]</p><p>    }</p><p>  },</p><p>  "sort": [</p><p>    {</p><p>      "id": {</p><p>        "order": "asc"      }</p><p>    }</p><p>  ]</p><p>}'</p><p>      6.避免前缀模糊匹配</p><p>        Elasticsearch默认支持通过*?正则表达式来做模糊匹配，如果在一个数据量超过10亿条的索引上执行模糊匹配，尤其是前缀模糊匹配，通常耗时会比较长，甚至可能导致内存溢出。尽量避免在高并发查询请求的生产环境执行这类操作。</p><p>        某客户需要对车牌号进行模糊查询，通过查询请求"车牌号:*A8848*"查询时，往往导致整个集群负载较高。通过对数据预处理，增加冗余字段"车牌号.keyword"，并事先将所有车牌号按照1元、2元、3元...7元分词后存储至该字段，字段存储内容示例:沪,A,8,4,沪A,A8,88,84,48,沪A8...沪A88488。通过查询"车牌号.keyword:A8848"即可解决原来的性能问题。</p><p>      7.避免索引稀疏</p><p>        Elasticsearch6.X之前的版本默认允许在一个index下面创建多个type，Elasticsearch6.X及之后的版本只允许创建一个type。在一个type下面创建多个字段不一样的type，或者将几百个字段不一样的索引合并到一个索引中，会导致索引稀疏问题。</p><p>        建议每个索引下只创建一个type，字段不一样的数据分别独立创建index，不要合并成一个大索引。每个查询请求根据需要去读取相应的索引，避免查询大索引扫描全部记录，加快查询速度。</p><p>      8.扩容集群节点个数、升级节点规格</p><p>        通常服务器节点数越多，服务器硬件配置规格越高，Elasticsearch集群的处理能力越强。</p><p>        在不同节点规模下的查询性能测试（测试环境：Elasticsearch5.5.3集群，单节点16核CPU、64G内存、2T SSD盘，10亿条人口户籍登记信息，数据大小1TB。）：</p><p>集群节点数副本数10并发检索平均响应时间50并发检索平均响应时间100并发检索平均响应时间200并发检索平均响应时间200并发QPS200并发CPU使用率200并发CPU IO等待</p><p>1077ms459ms438ms1001ms20016%52%</p><p>3038ms103ms162ms298ms66945%34%</p><p>32271ms356ms577ms818ms24419%54%</p><p>10021ms36ms48ms81ms246740%10%</p><p>        不同集群节点规模写入性能测试（测试环境：Elasticsearch6.3.2集群，单节点16核CPU、64G内存、2T SSD盘，10亿条人口户籍登记信息，单条记录1KB，数据集大小1TB，20个并发写入线程。）：</p><p>集群节点数副本数写入TPS耗时集群CPU使用率</p><p>1008894511242s50%</p><p>5001806385535s20%</p><p>        在条件允许的情况下，还是希望您可以通过实际的数据和使用场景测试出适合自己的最佳实践。得益于阿里云Elasticsearch提供的弹性扩容功能，您可以在实际使用时根据情况随时增加磁盘大小、扩容节点个数、升级节点规格。</p>
        </div>
      </div>
    </div>
  </body>
</html>
